---
author: "University of Melbourne Centre for Cancer Research"
date: "`r Sys.time()`"
output:
  html_document:
    theme: cosmo
    css: style.css
    code_download: true
    toc: true
  rmdformats::material:
    highlight: kate
params:
  title: "UMCCR TSO500 ctDNA Report"
  prefix: "x"
description: "UMCCR TSO500 ctDNA Report"
title: "`r params$title`"
---

__Prefix:__ __`r params$prefix`__

```{r knitr_opts, include=F}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE,
  warning = FALSE, message = FALSE
)
```

```{r load_pkgs}
require(tidyverse)
require(dracarys)
require(glue)
require(here)
require(knitr)
require(DT)
```

```{r data_setup}
options(scipen = 999) # disable scientific notation
pref <- params$prefix
trace <- glue("{pref}_TMB_Trace.tsv") |>
  TsoTmbTraceTsvFile$new() |>
  read()
fraglenhist <- glue("{pref}.fragment_length_hist.json.gz") |>
  TsoFragmentLengthHistFile$new()
cvg <- glue("{pref}.TargetRegionCoverage.json.gz") |>
  TsoTargetRegionCoverageFile$new()
# for accessing the histo plots
alcolfus_obj <- glue("{pref}.AlignCollapseFusionCaller_metrics.json.gz") |>
  TsoAlignCollapseFusionCallerMetricsFile$new()
alcolfus <- read(alcolfus_obj)
tmb <- glue("{pref}.tmb.json.gz") |>
  TsoTmbFile$new() |>
  read()
msi <- glue("{pref}.msi.json.gz") |>
  TsoMsiFile$new() |>
  read()
fus <- glue("{pref}_Fusions.csv") |>
  TsoFusionsCsvFile$new() |>
  read()
res <- glue("{pref}_SampleAnalysisResults.json.gz") |>
  TsoSampleAnalysisResultsFile$new() |>
  read()
```

```{r funcs, echo=F}
dt_view <- function(x, caption = NULL, scroll_y = 200) {
  x |>
    DT::datatable(
      filter = list(position = "top", clear = FALSE, plain = TRUE),
      class = "cell-border display compact",
      rownames = FALSE,
      extensions = c("Scroller", "Buttons", "KeyTable"),
      options = list(
        scroller = TRUE, scrollY = scroll_y, scrollX = TRUE,
        autoWidth = FALSE, keys = TRUE,
        buttons = c("csv", "excel"), dom = "Blfrtip"
      ),
      caption = caption
    )
}
```

## `SampleAnalysisResults.json.gz` {.tabset #SampleAnalysisResults}

### SNVs

```{r res_snvs}
res$vars$snvs |>
  dt_view()
```

### CNVs

```{r res_cnvs}
res$vars$cnvs |>
  dt_view()
```


### SampleInfo

```{r res_sample_info}
res$sample_info |>
  tidyr::pivot_longer(dplyr::everything(), names_to = "metric", values_to = "value") |>
  knitr::kable()
```

### SoftwareConfig

```{r res_sw_config}
res$software_config$data_sources |>
  knitr::kable()
res$software_config$other |>
  tidyr::pivot_longer(dplyr::everything(), names_to = "metric", values_to = "value") |>
  knitr::kable()
```

### Biomarkers (MSI/TMB)

```{r res_biom}
res$biomarkers |>
  knitr::kable(caption = "MSI/TMB metrics")
```

### QC1

```{r res_qc1}
res$sample_metrics_qc |>
  tidyr::pivot_longer(cols = dplyr::everything(), names_to = "metric", values_to = "value") |>
  knitr::kable()
```

### QC2

```{r res_qc2}
res$sample_metrics_expanded |>
  tidyr::pivot_longer(dplyr::everything(), names_to = "metric", values_to = "value") |>
  knitr::kable()
```

---

## `Fusions.csv`

```{r fusions}
fus |>
  dplyr::select(-"Contig") |>
  dt_view()
```


## `tmb.json.gz`

```{r tmb}
tmb |>
  tidyr::pivot_longer(dplyr::everything(), names_to = "metric", values_to = "value") |>
  knitr::kable()
```

## `msi.json.gz`

```{r msi}
msi |>
  dplyr::mutate(dplyr::across(.fns = as.character)) |>
  tidyr::pivot_longer(dplyr::everything(), names_to = "metric", values_to = "value") |>
  knitr::kable()
```

---

## `TMB_Trace.tsv`


```{r tmb_trace}
trace |>
  dplyr::mutate(
    Position = as.integer(Position),
    VAF = as.numeric(VAF),
    Depth = as.numeric(Depth),
    GermlineFilterDatabase = as.logical(GermlineFilterDatabase),
    GermlineFilterProxi = as.logical(GermlineFilterProxi),
    CodingVariant = as.logical(CodingVariant),
    Nonsynonymous = as.logical(Nonsynonymous),
    IncludedInTMBNumerator = as.logical(IncludedInTMBNumerator)
  ) |>
  dplyr::select(
    chrom = "Chromosome", pos = "Position", ref = "RefCall", alt = "AltCall", "VAF",
    dp = "Depth", "GermlineFilterProxi", "IncludedInTMBNumerator", dplyr::everything()
  ) |>
  dt_view()
```

## `fragment_length_hist.json.gz`

```{r fraglenhist_plot}
plot(fraglenhist)
# read(fraglenhist) |> dt_view()
```

## `TargetRegionCoverage.json.gz` {.tabset}

### Plot

```{r cvg}
plot(cvg)
```

### Data

```{r cvg2}
read(cvg) |> dt_view()
```

## `AlignCollapseFusionCaller_metrics.json.gz` {.tabset #AlignCollapseFusionCaller_metrics}

### CoverageSummary

```{r met1}
alcolfus |>
  dplyr::filter(section == "CoverageSummary") |>
  dplyr::select(-"section") |>
  dt_view()
```

### MappingAligningPerRg

```{r met2}
alcolfus |>
  dplyr::filter(section == "MappingAligningPerRg") |>
  dplyr::select(-"section") |>
  dt_view()
```

### MappingAligningSummary

```{r met3}
alcolfus |>
  dplyr::filter(section == "MappingAligningSummary") |>
  dplyr::select(-"section") |>
  dt_view()
```

### RunTime

```{r met4}
alcolfus |>
  dplyr::filter(section == "RunTime") |>
  dplyr::select(-"section") |>
  dt_view()
```

### SvSummary

```{r met5}
alcolfus |>
  dplyr::filter(section == "SvSummary") |>
  dplyr::select(-"section") |>
  dt_view()
```

### TrimmerStatistics

```{r met6}
alcolfus |>
  dplyr::filter(section == "TrimmerStatistics") |>
  dplyr::select(-"section") |>
  dt_view()
```

### UmiStatistics

```{r met7}
alcolfus |>
  dplyr::filter(section == "UmiStatistics", !grepl("Hist", .data$name)) |>
  dplyr::select(-"section") |>
  dt_view()
```

### UmiStatistics-Histo

```{r met8}
p <- alcolfus_obj |>
  read() |>
  alcolfus_obj$histoplot(max_num = 20)
p$p_num_supporting_fragments
p$p_unique_umis_per_frag_pos
```

---
