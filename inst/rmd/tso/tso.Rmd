---
author: "University of Melbourne Centre for Cancer Research"
date: "`r Sys.time()`"
output:
  html_document:
    theme: cosmo
    css: style.css
    code_download: true
    toc: true
  rmdformats::material:
    highlight: kate
params:
  title: "UMCCR TSO500 ctDNA Report"
  rds: "/path/to/rds"
description: "UMCCR TSO500 ctDNA Report"
title: "`r params$title`"
---

__RDS:__ __`r params$rds`__

```{r knitr_opts, include=F}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE,
  warning = FALSE, message = FALSE
)
```

```{r load_pkgs}
require(tidyverse)
require(dracarys)
require(here)
require(knitr)
require(DT)
```

```{r data_setup}
options(scipen = 999) # disable scientific notation
stopifnot(file.exists(params$rds))
# read tibble and convert to list of file types
rds_raw <- params$rds |>
  readr::read_rds()
rds_nms <- rds_raw[["type"]]
rds <- rds_raw |>
  purrr::transpose() |>
  purrr::set_names(rds_nms)

trace <- rds[["tso__tmb_trace_tsv"]][["dat"]]
fraglenhist_plot <- rds[["tso__fragment_length_hist"]][["plot"]]
cvg_plot <- rds[["tso__target_region_coverage"]][["plot"]]
alcolfus <- rds[["tso__align_collapse_fusion_caller_metrics"]][["dat"]] |>
  # remove histo data since already have plot
  dplyr::filter(!(grepl("Hist", .data$name) & .data$section == "UmiStatistics"))
alcolfus_plot <- rds[["tso__align_collapse_fusion_caller_metrics"]][["plot"]]
tmb <- rds[["tso__tmb"]][["dat"]]
msi <- rds[["tso__msi"]][["dat"]]
fus <- rds[["tso__fusions_csv"]][["dat"]]
res <- rds[["tso__sample_analysis_results"]][["dat"]]
```

```{r funcs, echo=F}
dt_view <- function(x, caption = NULL, scroll_y = 200) {
  x |>
    DT::datatable(
      filter = list(position = "top", clear = FALSE, plain = TRUE),
      class = "cell-border display compact",
      rownames = FALSE,
      extensions = c("Scroller", "Buttons", "KeyTable"),
      options = list(
        scroller = TRUE, scrollY = scroll_y, scrollX = TRUE,
        autoWidth = FALSE, keys = TRUE,
        buttons = c("csv", "excel"), dom = "Blfrtip"
      ),
      caption = caption
    )
}
```

## `SampleAnalysisResults.json.gz`

### SNVs

```{r res_snvs}
res$snvs |>
  dt_view()
```

### CNVs

```{r res_cnvs}
res$cnvs |>
  dt_view()
```

### SampleInfo

```{r res_sample_info}
res$sample_info |>
  tidyr::pivot_longer(dplyr::everything(), names_to = "metric", values_to = "value") |>
  knitr::kable()
```

### SoftwareConfig

```{r res_sw_config}
res$software_config$data_sources |>
  knitr::kable()
res$software_config$other |>
  tidyr::pivot_longer(dplyr::everything(), names_to = "metric", values_to = "value") |>
  knitr::kable()
```

### Biomarkers (MSI/TMB)

```{r res_biom}
res$biomarkers |>
  knitr::kable(caption = "MSI/TMB metrics")
```

### QC

```{r res_qc1}
res$qc |>
  tidyr::pivot_longer(cols = dplyr::everything(), names_to = "metric", values_to = "value") |>
  dt_view()
```

---

## `Fusions.csv`

```{r fusions}
fus |>
  dplyr::select(-"Contig") |>
  dt_view()
```

## `tmb.json.gz`

```{r tmb}
tmb |>
  tidyr::pivot_longer(dplyr::everything(), names_to = "metric", values_to = "value") |>
  knitr::kable()
```

## `msi.json.gz`

```{r msi}
msi |>
  dplyr::mutate(dplyr::across(.fns = as.character)) |>
  tidyr::pivot_longer(dplyr::everything(), names_to = "metric", values_to = "value") |>
  knitr::kable()
```

---

## `TMB_Trace.tsv`


```{r tmb_trace}
trace |>
  dplyr::mutate(
    Position = as.integer(Position),
    VAF = as.numeric(VAF),
    Depth = as.numeric(Depth),
    GermlineFilterDatabase = as.logical(GermlineFilterDatabase),
    GermlineFilterProxi = as.logical(GermlineFilterProxi),
    CodingVariant = as.logical(CodingVariant),
    Nonsynonymous = as.logical(Nonsynonymous),
    IncludedInTMBNumerator = as.logical(IncludedInTMBNumerator)
  ) |>
  dplyr::select(
    chrom = "Chromosome", pos = "Position", ref = "RefCall", alt = "AltCall", "VAF",
    dp = "Depth", "GermlineFilterProxi", "IncludedInTMBNumerator", dplyr::everything()
  ) |>
  dt_view()
```

## `fragment_length_hist.json.gz`

```{r fraglenhist_plot}
fraglenhist_plot
```

## `TargetRegionCoverage.json.gz`

```{r cvg_plot}
cvg_plot
```

## `AlignCollapseFusionCaller_metrics.json.gz` {.tabset #AlignCollapseFusionCaller_metrics}

### CoverageSummary

```{r met1}
alcolfus |>
  dplyr::filter(section == "CoverageSummary") |>
  dplyr::select(-"section") |>
  dt_view()
```

### MappingAligningPerRg

```{r met2}
alcolfus |>
  dplyr::filter(section == "MappingAligningPerRg") |>
  dplyr::select(-"section") |>
  dt_view()
```

### MappingAligningSummary

```{r met3}
alcolfus |>
  dplyr::filter(section == "MappingAligningSummary") |>
  dplyr::select(-"section") |>
  dt_view()
```

### RunTime

```{r met4}
alcolfus |>
  dplyr::filter(section == "RunTime") |>
  dplyr::select(-"section") |>
  dt_view()
```

### SvSummary

```{r met5}
alcolfus |>
  dplyr::filter(section == "SvSummary") |>
  dplyr::select(-"section") |>
  dt_view()
```

### TrimmerStatistics

```{r met6}
alcolfus |>
  dplyr::filter(section == "TrimmerStatistics") |>
  dplyr::select(-"section") |>
  dt_view()
```

### UmiStatistics

```{r met7}
alcolfus |>
  dplyr::filter(section == "UmiStatistics", !grepl("Hist", .data$name)) |>
  dplyr::select(-"section") |>
  dt_view()
```

### UmiStatistics-Histo

```{r met8}
alcolfus_plot$p_num_supporting_fragments
alcolfus_plot$p_unique_umis_per_frag_pos
```

---
