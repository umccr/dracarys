---
author: "University of Melbourne Centre for Cancer Research"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    theme: cosmo
    code_download: true
  rmdformats::material:
    highlight: kate
params:
  title: "UMCCR umccrise Summary Report"
description: "UMCCR umccrise Summary Report"
title: "`r params$title`"
---

```{r knitr_opts, include=F}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE,
  warning = FALSE, message = FALSE
)
```

```{css}
.navbar-brand {
  padding: 5px 15px;
}

.dropdown:hover > .dropdown-menu {
  display: block;
}
.dropdown > .dropdown-toggle:active {
  pointer-events: none;
}

.main-container {
  max-width: 1400px !important;
  margin-left: auto;
  margin-right: auto;
}

.navbar-default {
  color: #750075;
  background-color: #750075;
}
```

```{r load_pkgs}
{
  require(dplyr)
  require(readr, include.only = c("read_rds"))
  require(purrr, include.only = c("map"))
  require(tidyr, include.only = c("unnest", "unnest_wider"))
  require(dracarys)
  require(glue, include.only = "glue")
  require(here, include.only = "here")
  require(knitr, include.only = "kable")
  require(DT, include.only = "datatable")
  require(fs, include.only = c("dir_ls"))
}
```

```{r data_setup, eval=FALSE}
options(width = 150)
token <- dracarys::ica_token_validate(Sys.getenv("ICA_ACCESS_TOKEN_PRO"))
pmeta <- here::here("nogit/umccrise/rds/portal_meta/2023-09-04_pmeta_final.rds") |>
  readr::read_rds()

gds_map <- pmeta |>
  rowwise() |>
  mutate(
    gds_contents = list(dracarys::gds_files_list_filter_relevant(
      gdsdir = .data$gds_outdir_umccrise, token = token, include = "PresignedUrl"
    ))
  ) |>
  ungroup() |>
  tidyr::unnest("gds_contents") |>
  select(
    "portal_run_id", "SubjectID", "LibraryID_tumor", "LibraryID_normal",
    "start", "end", "type", "bname", "size", "file_id", "path", "presigned_url"
  ) |>
  filter(type != "MultiqcFile")

saveRDS(gds_map, here::here("nogit/umccrise/rds/gds_map_2023-09-05.rds"))

parse_files <- function(gds_map, row_slice) {
  start_time <- Sys.time()
  dat1 <- gds_map |>
    slice(row_slice) |>
    rowwise() |>
    mutate(
      gen = list(dracarys::dr_func_eval(.data$type)),
      obj = list(.data$gen$new(.data$presigned_url)),
      objp = list(.data$obj$read())
    ) |>
    ungroup()
  end_time <- Sys.time()
  total_time <- end_time - start_time
  print(total_time)
  dat1
}

gds_map <- readr::read_rds(here::here("nogit/umccrise/rds/gds_map_2023-09-05.rds"))
x1 <- parse_files(gds_map, 1:500)
x2 <- parse_files(gds_map, 501:1000)
x3 <- parse_files(gds_map, 1001:1500)
x4 <- parse_files(gds_map, 1501:2000)
x5 <- parse_files(gds_map, 2001:2245)

o <- dat1 |>
  mutate(
    type = case_when(
      grepl("snv_2015.tsv.gz", bname) ~ "UmSigsSnvFile2015",
      grepl("snv_2020.tsv.gz", bname) ~ "UmSigsSnvFile2020",
      .default = .data$type
    )
  ) |>
  select(
    portal_run_id,
    SubjectID,
    LibraryID_tumor,
    LibraryID_normal,
    type,
    objp
  )

umqc <- o |>
  filter(type == "UmQcSumFile") |>
  tidyr::unnest_wider(objp) |>
  select(-c(type))
hrd_chord <- o |>
  filter(type == "UmChordTsvFile") |>
  tidyr::unnest_wider(objp) |>
  select(-c(type))
hrd_hrdetect <- o |>
  filter(type == "UmHrdetectTsvFile") |>
  tidyr::unnest_wider(objp) |>
  select(-c(type))
sigs_2015 <- o |>
  filter(type == "UmSigsSnvFile2015") |>
  tidyr::unnest_wider(objp) |>
  select(-c(type))
sigs_2020 <- o |>
  filter(type == "UmSigsSnvFile2020") |>
  tidyr::unnest_wider(objp) |>
  select(-c(type))
```

---

## Session Info

```{r session_info, echo=FALSE, eval=FALSE}
pkgs_of_interest <- c("base", "dracarys", "tidyverse", "tidyselect", "ggplot2", "dplyr", "tidyr", "readr")
# need dracarys for session info
si <- dracarys::session_info_kable(pkgs_of_interest)
si$si_pkg
si$si_pl
```
