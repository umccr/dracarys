---
author: "University of Melbourne Centre for Cancer Research"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    theme: cosmo
    code_download: true
  rmdformats::material:
    highlight: kate
params:
  title: "UMCCR umccrise Summary Report"
description: "UMCCR umccrise Summary Report"
title: "`r params$title`"
---

```{r knitr_opts, include=F}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE,
  warning = FALSE, message = FALSE
)
```

```{css}
.navbar-brand {
  padding: 5px 15px;
}

.dropdown:hover > .dropdown-menu {
  display: block;
}
.dropdown > .dropdown-toggle:active {
  pointer-events: none;
}

.main-container {
  max-width: 1400px !important;
  margin-left: auto;
  margin-right: auto;
}

.navbar-default {
  color: #750075;
  background-color: #750075;
}
```

```{r load_pkgs}
{
  require(dplyr)
  require(readr, include.only = c("read_rds"))
  require(purrr, include.only = c("map"))
  require(tidyr, include.only = c("unnest", "unnest_wider"))
  require(dracarys)
  require(glue, include.only = "glue")
  require(here, include.only = "here")
  require(knitr, include.only = "kable")
  require(DT, include.only = "datatable")
  require(fs, include.only = c("dir_ls"))
}
```

```{r data_setup, eval=FALSE}
options(width = 150)
token <- dracarys::ica_token_validate(Sys.getenv("ICA_ACCESS_TOKEN_PRO"))
pmeta <- here("nogit/umccrise/rds/portal_meta/2023-09-04_pmeta_final.rds") |>
  readr::read_rds()

gds_map <- pmeta |>
  rowwise() |>
  mutate(
    gds_contents = list(dracarys::gds_files_list_filter_relevant(
      gdsdir = .data$gds_outdir_umccrise, token = token, include = "PresignedUrl"
    ))
  ) |>
  ungroup() |>
  tidyr::unnest("gds_contents") |>
  select(
    "portal_run_id", "SubjectID", "LibraryID_tumor", "LibraryID_normal",
    "start", "end", "type", "bname", "size", "file_id", "path", "presigned_url"
  ) |>
  filter(type != "MultiqcFile")

saveRDS(gds_map, here("nogit/umccrise/rds/gds_map_2023-09-05.rds"))

parse_files <- function(gds_map, row_slice, rds_out) {
  start_time <- Sys.time()
  dat1 <- gds_map |>
    dplyr::slice(row_slice) |>
    dplyr::rowwise() |>
    dplyr::mutate(
      gen = list(dracarys::dr_func_eval(.data$type)),
      obj = list(.data$gen$new(.data$presigned_url)),
      objp = list(.data$obj$read())
    ) |>
    dplyr::ungroup()
  end_time <- Sys.time()
  total_time <- end_time - start_time
  print(total_time)
  readr::write_rds(x = dat1, file = rds_out)
}

gds_map <- readr::read_rds(here("nogit/umccrise/rds/gds_map_2023-09-05.rds"))
rds_path_out <- here("nogit/umccrise/rds/results")
x0 <- parse_files(gds_map, 1:10, file.path(rds_path_out, "x0.rds"))
x1 <- parse_files(gds_map, 1:500, file.path(rds_path_out, "x1.rds"))
x2 <- parse_files(gds_map, 501:1000, file.path(rds_path_out, "x2.rds"))
x3 <- parse_files(gds_map, 1001:1500, file.path(rds_path_out, "x3.rds"))
x4 <- parse_files(gds_map, 1501:2000, file.path(rds_path_out, "x4.rds"))
x5 <- parse_files(gds_map, 2001:2245, file.path(rds_path_out, "x5.rds"))
```

```{r data_load}
dat1 <- fs::dir_ls(here("nogit/umccrise/rds/results")) |>
  purrr::map(readr::read_rds) |>
  dplyr::bind_rows()

o <- dat1 |>
  mutate(
    type = case_when(
      grepl("snv_2015.tsv.gz", bname) ~ "UmSigsSnvFile2015",
      grepl("snv_2020.tsv.gz", bname) ~ "UmSigsSnvFile2020",
      .default = .data$type
    )
  ) |>
  select(
    portal_run_id,
    SubjectID,
    LibraryID_tumor,
    LibraryID_normal,
    type,
    objp
  )

dt_view <- function(x, ...) {
  x |>
    dplyr::mutate(across(where(is.character), as.factor)) |>
    DT::datatable(
      filter = list(position = "top", clear = FALSE, plain = TRUE),
      class = "cell-border display compact",
      rownames = FALSE,
      extensions = c("Scroller", "Buttons", "KeyTable"),
      options = list(
        scroller = TRUE, scrollY = 600, scrollX = TRUE,
        autoWidth = FALSE, keys = TRUE,
        buttons = c("csv", "excel"), dom = "Blfrtip"
      ),
      escape = FALSE,
      ...
    )
}

qcsum <- o |>
  filter(type == "UmQcSumFile") |>
  unnest_wider(objp) |>
  select(-c(type))
hrd_chord <- o |>
  filter(type == "UmChordTsvFile") |>
  unnest_wider(objp) |>
  select(-c(type))
hrd_hrdetect <- o |>
  filter(type == "UmHrdetectTsvFile") |>
  unnest_wider(objp) |>
  select(-c(type))
sigs_2015 <- o |>
  filter(type == "UmSigsSnvFile2015") |>
  unnest_wider(objp) |>
  select(-c(type))
sigs_2020 <- o |>
  filter(type == "UmSigsSnvFile2020") |>
  unnest_wider(objp) |>
  select(-c(type))
```


```{r}
dt_view(qcsum, caption = "QC Summary")
dt_view(hrd_chord, caption = "CHORD")
dt_view(hrd_hrdetect, caption = "HRDetect")
```

## TODO

- Add links to Portal per Subject

---

## Session Info

```{r session_info, echo=FALSE, eval=FALSE}
pkgs_of_interest <- c("base", "dracarys", "tidyverse", "tidyselect", "ggplot2", "dplyr", "tidyr", "readr")
# need dracarys for session info
si <- dracarys::session_info_kable(pkgs_of_interest)
si$si_pkg
si$si_pl
```
