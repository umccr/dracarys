---
author: "University of Melbourne Centre for Cancer Research"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    theme: cosmo
    css: style.css
    code_download: true
  rmdformats::material:
    highlight: kate
params:
  title: "UMCCR TSO_CTDNA_TUMOR_ONLY Summary"
description: "UMCCR TSO500 ctDNA Summary Report"
title: "`r params$title`"
---

```{r knitr_opts, include=F}
knitr::opts_chunk$set(
  collapse = TRUE, echo = FALSE,
  warning = FALSE, message = FALSE
)
```

```{r load_pkgs}
{
  require(dracarys)
  require(dplyr)
  require(tidyr)
  require(purrr)
  require(tibble)
  require(readr)
  require(glue, include.only = "glue")
  require(here, include.only = "here")
  require(knitr, include.only = "kable")
  require(DT)
  require(fs)
  spark_home_pd <- file.path(Sys.getenv("SPARK_HOME"), "R", "lib")
  require(SparkR, lib.loc = spark_home_pd)
  SparkR::sparkR.session(master = "local[*]", sparkConfig = list(spark.driver.memory = "2g"))
}
```

```{r data_setup, eval=FALSE}
# options(scipen = 999)
# options(width = 150)
token <- dracarys::ica_token_validate(Sys.getenv("ICA_ACCESS_TOKEN_PRO"))
pmeta <- here("nogit/data_portal/workflows/2023-06-10.csv") |>
  dracarys::meta_tso_ctdna_tumor_only()

gds_map <- pmeta |>
  dplyr::slice(1:3) |>
  dplyr::rowwise() |>
  dplyr::mutate(
    gds_outdir_contents = list(dracarys::gds_files_list_filter_relevant(
      gdsdir = .data$gds_outdir, token = token, include = "PresignedUrl"
    ))
  ) |>
  dplyr::ungroup() |>
  tidyr::unnest("gds_outdir_contents") |>
  dplyr::select(
    "wfr_id", "portal_run_id", "SubjectID", "LibraryID",
    "start", "end", "type", "bname", "size", "file_id", "path", "presigned_url"
  )

dat1 <- gds_map |>
  dplyr::filter(!.data$type %in% c("TsoMergedSmallVariantsVcfFile", "TsoSampleAnalysisResultsFile")) |>
  dplyr::rowwise() |>
  dplyr::mutate(
    gen = list(func_selector(.data$type)),
    obj = list(.data$gen$new(.data$presigned_url)),
    objp = list(.data$obj$read())
  ) |>
  dplyr::ungroup()

dat1 |>
  dplyr::rowwise() |>
  dplyr::mutate(
    obj_write = list(.data$obj$write(
      .data$objp,
      prefix = glue("catalog.tso_ctdna_tumor_only.{.data$type}"),
      out_format = "delta", drid = .data$wfr_id
    ))
  ) |>
  dplyr::ungroup()
```

```{r data_setup2}
alcolfus_hist <- tso_unnest(x1 = "tso__alcolfuscaller_metrics_hist", d1 = d)
alcolfus_main <- tso_unnest(x1 = "tso__alcolfuscaller_metrics_main", d1 = d)
fus <- tso_unnest(x1 = "tso__fusions", d1 = d)
sar_biomarkers <- tso_unnest(x1 = "tso__sar_biomarkers", d1 = d)
sar_cnv <- tso_unnest(x1 = "tso__sar_cnv", d1 = d)
sar_qc <- tso_unnest(x1 = "tso__sar_qc", d1 = d)
sar_sampleinfo <- tso_unnest(x1 = "tso__sar_sampleinfo", d1 = d)
sar_smallv <- tso_unnest(x1 = "tso__sar_smallv", d1 = d)
sar_swconfds <- tso_unnest(x1 = "tso__sar_swconfds", d1 = d)
sar_swconfother <- tso_unnest(x1 = "tso__sar_swconfother", d1 = d)
tmb_trace <- tso_unnest(x1 = "tso__tmb_trace", d1 = d)
target_region_cov <- tso_unnest(x1 = "tso__target_region_coverage", d1 = d)
fraglen <- tso_unnest(x1 = "tso__fraglength_hist", d1 = d)
msi <- tso_unnest(x1 = "tso__msi", d1 = d)
multiqc <- tso_unnest(x1 = "tso__multiqc", d1 = d)
tmb <- tso_unnest(x1 = "tso__tmb", d1 = d)
```

```{r funcs}
# can use this to view smallish tables, just don't use it on big ones!
dt_view <- function(x, caption = NULL, scroll_y = 200) {
  x |>
    DT::datatable(
      filter = list(position = "top", clear = FALSE, plain = TRUE),
      class = "cell-border display compact",
      rownames = FALSE,
      extensions = c("Scroller", "Buttons", "KeyTable"),
      options = list(
        scroller = TRUE, scrollY = scroll_y, scrollX = TRUE,
        autoWidth = FALSE, keys = TRUE,
        buttons = c("csv", "excel"), dom = "Blfrtip"
      ),
      caption = caption
    )
}
```

## `Metadata`

```{r meta}
pmeta |>
  dt_view()
```

## `SampleAnalysisResults.json.gz` {.tabset #SampleAnalysisResults}

### SNVs

```{r sar_smallv}
sar_smallv
```

### CNVs

```{r sar_cnv}
sar_cnv
```

### SampleInfo

```{r sar_biomarkers}
sar_sampleinfo
```

### SoftwareConfig {.tabset}

#### datasources

```{r res_sw_config}
sar_swconfds
```

#### other

```{r res_sw_config2}
sar_swconfother
```

### Biomarkers (MSI/TMB)

```{r res_biom}
sar_biomarkers
```

### QC1

```{r res_qc1}
sar_qc |> glimpse()
```

---

## `Fusions.csv`

```{r fusions}
fus
```


## `tmb.json.gz`

```{r tmb}
tmb
```

## `msi.json.gz`

```{r msi}
msi
```

---

## `TMB_Trace.tsv`


```{r tmb_trace}
tmb_trace |>
  select(
    wfr_id,
    chrom = "Chromosome", pos = "Position", ref = "RefCall", alt = "AltCall", "VAF",
    dp = "Depth", "GermlineFilterProxi", "IncludedInTMBNumerator", everything()
  ) |>
  glimpse()
```

## `fragment_length_hist.json.gz`

```{r fraglenhist_plot}
fraglen
```

## `TargetRegionCoverage.json.gz`

```{r cvg}
target_region_cov
```

## `AlignCollapseFusionCaller_metrics.json.gz` {.tabset #AlignCollapseFusionCaller_metrics}

### CoverageSummary

```{r met1}
alcolfus_main |>
  filter(section == "CoverageSummary") |>
  mutate(
    value = ifelse(grepl("Aligned .* in genome", name), glue("{value} ({percent}%)"), value)
  ) |>
  select(-c("section", "percent")) |>
  pivot_wider(names_from = "name", values_from = "value") |>
  dt_view()
```

### MappingAligningPerRg

```{r met2}
alcolfus_main |>
  filter(section == "MappingAligningPerRg") |>
  mutate(
    value = ifelse(!is.na(percent), glue("{value} ({percent}%)"), value)
  ) |>
  select(-c("section", "percent")) |>
  pivot_wider(names_from = "name", values_from = "value") |>
  glimpse()
```

### MappingAligningSummary

```{r met3}
alcolfus_main |>
  filter(section == "MappingAligningSummary") |>
  mutate(
    value = ifelse(!is.na(percent), glue("{value} ({percent}%)"), value)
  ) |>
  select(-c("section", "percent")) |>
  filter(!is.na(name)) |> # temp
  pivot_wider(names_from = "name", values_from = "value") |>
  glimpse()
```

### RunTime

```{r met4}
alcolfus_main |>
  filter(section == "RunTime") |>
  mutate(value = glue("{value} ({percent}sec)")) |>
  select(-c("section", "percent")) |>
  pivot_wider(names_from = "name", values_from = "value") |>
  dt_view()
```

### SvSummary

```{r met5}
alcolfus_main |>
  filter(.data$section == "SvSummary") |>
  mutate(value = as.numeric(.data$value)) |>
  select(-c("section", "percent")) |>
  pivot_wider(names_from = "name", values_from = "value") |>
  dt_view()
```

### TrimmerStatistics

```{r met6}
# for these the percent is NA
numeric_cols <- c(
  "Average bases trimmed per read", "Average bases trimmed per trimmed read",
  "Average input read length", "Total input bases", "Total input bases R1",
  "Total input bases R2", "Total input reads"
)
alcolfus_main |>
  filter(section == "TrimmerStatistics") |>
  mutate(
    value = ifelse(!is.na(percent), glue("{value} ({percent}%)"), value)
  ) |>
  select(-c("section", "percent")) |>
  pivot_wider(names_from = "name", values_from = "value") |>
  mutate(across(all_of(numeric_cols), as.numeric)) |>
  dt_view()
```

### UmiStatistics

```{r met7}
# for these the percent is NA
numeric_cols <- c(
  "Collapsible region size standard deviation", "Consensus pairs emitted",
  "Max collapsible region size (num reads)", "Mean collapsible region size (num reads)",
  "Mean family depth", "Min collapsible region size (num reads)",
  "Number of collapsible regions", "Number of reads", "On target mean family depth",
  "On target number of reads", "Total number of families"
)

alcolfus_main |>
  filter(section == "UmiStatistics") |>
  mutate(
    value = ifelse(!is.na(percent), glue("{value} ({percent}%)"), value)
  ) |>
  select(-c("section", "percent")) |>
  pivot_wider(names_from = "name", values_from = "value") |>
  mutate(across(all_of(numeric_cols), as.numeric)) |>
  dt_view()
```

---

## Session Info

```{r session_info, echo=FALSE, eval=FALSE}
pkgs_of_interest <- c("base", "dracarys", "tidyverse", "tidyselect", "ggplot2", "dplyr", "tidyr", "readr")
# need dracarys for session info, comment out below if not available
si <- dracarys::session_info_kable(pkgs_of_interest)
si$si_pkg
si$si_pl
```
