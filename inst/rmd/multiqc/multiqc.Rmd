---
author: "University of Melbourne Centre for Cancer Research"
date: "`r Sys.time()`"
output:
  html_document:
    theme: cosmo
    code_download: true
  rmdformats::material:
    highlight: kate
description: "UMCCR MultiQC JSON Summary"
title: "MultiQC JSON Summary"
---

```{r knitr_opts, include=F}
knitr::opts_chunk$set(
  collapse = TRUE, echo = TRUE,
  warning = FALSE, message = FALSE
)
```

```{r setup, message=FALSE, warning=FALSE}
library(dracarys)
library(dplyr)
library(ggplot2)
library(tibble)
library(here)
library(fs)
```


```{r}
date1 <- "2023-02-07"
res <- here(glue("nogit/multiqc/{date1}")) |>
  dir_ls(recurse = TRUE, regexp = "_multiqc\\.tsv\\.gz") |>
  as_tibble_col(column_name = "path") |>
  mutate(
    bname = basename(path),
    date_hash = basename(dirname(path)),
    sbj = sub("(.*)_multiqc.tsv.gz", "\\1", bname),
    sbj_date_hash = glue("{sbj}_{date_hash}")
  )

l1 <- vector("list", nrow(res)) |> purrr::set_names(res$sbj_date_hash)
for (i in seq_len(nrow(res))) {
  l1[[i]] <- readr::read_tsv(res$path[i], show_col_types = FALSE)
}
dat <- dplyr::bind_rows(l1, .id = "sbj_date_hash") |>
  tidyr::separate(col = sbj_date_hash, sep = "_", into = c("umccr_sbj", "date1", "hash1")) |>
  dplyr::mutate(
    pheno = dplyr::if_else(is.na(purity_purple1), "normal", "tumor"),
    date = lubridate::ymd_hm(sub("_", " ", date))
  )
dat |>
  dplyr::select(umccr_sbj, umccr_id, date, pheno, hash1, dplyr::contains("dupmark"), dplyr::everything(), -c(date1, umccr_workflow)) |>
  readr::write_tsv(here("nogit/multiqc/2023-02-13_results.tsv"))

dat |>
  tidyr::pivot_longer(contains("dupmark"), names_to = "metric", values_to = "value") |>
  # dplyr::filter(metric %in% c("reads_num_dupmarked_dragen", "reads_num_dupmarked_samtools")) |>
  ggplot(aes(x = date, y = value)) +
  geom_point(aes(colour = pheno)) +
  facet_grid(metric ~ pheno, scales = "free") +
  theme_bw()
```
